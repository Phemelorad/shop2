<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Loan Status</title>
  <link rel="stylesheet" href="header.css" />
  <link rel="stylesheet" href="navigation.css" />
  <link rel="stylesheet" href="table.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
</head>
<body>
<header class="txt">
  <h1>RADIPODI MICRO LOANS</h1>
  <h4>"Funding Tomorrow, Today."</h4>
  <section>
    <div class="nav">
      <button onclick="location.href='apply.html'">Apply Now</button>
      <button onclick="location.href='status.html'">Check Loan Status</button>
      <button onclick="location.href='repay.html'">Repay</button>
    </div>
  </section>
</header>


<table border="1" id="loan-status-table">
  <thead>
    <tr>
      <th>Name</th>
      <th>Loan Amount (P)</th>
      <th>Interest Rate (%)</th>
      <th>Total Owed (P)</th>
      <th>Duration (Months)</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    <!-- Rows will be added here dynamically -->
  </tbody>
</table>

<script>
  const supabaseUrl = 'https://cgitlcuheoncjmxxcipq.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnaXRsY3VoZW9uY2pteHhjaXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NDg5ODEsImV4cCI6MjA2NjQyNDk4MX0.iVIEEhx6YIx4JgWseMwwddGLuKn6in4aUV_CHd2srmE'; // Replace with your anon key
  const { createClient } = supabase;
  const supabase = createClient(supabaseUrl, supabaseKey);

  async function loadLoanStatus() {
    // Fetch loan data joined with applicants
    const { data, error } = await supabase
      .from('loan_applications')
      .select(`
        loan_id,
        loan_amount,
        interest_rate,
        repayment_months,
        status,
        applicants ( name, surname )
      `);

    if (error) {
      console.error('Error loading loan status:', error);
      return;
    }

    const tbody = document.querySelector('#loan-status-table tbody');
    tbody.innerHTML = ''; // Clear previous rows

    data.forEach(loan => {
      const totalOwed = (loan.loan_amount * (1 + (loan.interest_rate / 100))).toFixed(2);

      const row = document.createElement('tr');

      row.innerHTML = `
        <td>${loan.applicants?.name ?? 'N/A'} ${loan.applicants?.surname ?? ''}</td>
        <td>P${loan.loan_amount.toLocaleString()}</td>
        <td>${loan.interest_rate.toFixed(2)}%</td>
        <td>P${parseFloat(totalOwed).toLocaleString()}</td>
        <td>${loan.repayment_months}</td>
        <td class="${loan.status.toLowerCase()}">${loan.status.charAt(0).toUpperCase() + loan.status.slice(1)}</td>
      `;

      tbody.appendChild(row);
    });
  }

  // Load the data when the page loads
  window.onload = loadLoanStatus;
</script>
</body>
</html>
