<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Loan Status</title>
  <link rel="stylesheet" href="header.css" />
  <link rel="stylesheet" href="navigation.css" />
  <link rel="stylesheet" href="table.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
  <header class="txt">
    <h1>RADIPODI MICRO LOANS</h1>
    <h4>"Funding Tomorrow, Today."</h4>
    <section>
      <div class="nav">
        <button onclick="location.href='apply.html'">Apply Now</button>
        <button onclick="location.href='status.html'">Check Loan Status</button>
        <button onclick="location.href='repay.html'">Repay</button>
      </div>
    </section>
    <div id="user-info" style="padding: 10px; background: #eee;">
      <span id="user-email" style="font-weight: bold;"></span>
      <button id="logout-btn" style="display:none;">Logout</button>
    </div>
  </header>

  <h2>Loan Applications Status</h2>
  <table border="1" id="loan-status-table">
    <thead>
      <tr>
        <th>Loan Amount (P)</th>
        <th>Interest (%)</th>
        <th>Total Owed (P)</th>
        <th>Repayment Months</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  const supabaseUrl = 'https://cgitlcuheoncjmxxcipq.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnaXRsY3VoZW9uY2pteHhjaXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NDg5ODEsImV4cCI6MjA2NjQyNDk4MX0.iVIEEhx6YIx4JgWseMwwddGLuKn6in4aUV_CHd2srmE'; // Keep your real key
  const { createClient } = supabase;
  const supabaseClient = createClient(supabaseUrl, supabaseKey);

  async function loadUserLoanStatus() {
    const { data: { user }, error } = await supabaseClient.auth.getUser();

    const userEmailSpan = document.getElementById("user-email");
    const logoutBtn = document.getElementById("logout-btn");

    if (error || !user) {
      // Redirect to login if no user session
      window.location.href = "login.html";
      return;
    }

    userEmailSpan.textContent = `Logged in as: ${user.email}`;
    logoutBtn.style.display = "inline-block";

    // Fetch the applicant_id by user email
    const { data: applicants, error: applicantError } = await supabaseClient
      .from("applicants")
      .select("applicant_id")
      .eq("email", user.email);

    if (applicantError || !applicants || applicants.length === 0) {
      alert("No loan record found for this user.");
      return;
    }

    const applicant_id = applicants[0].applicant_id;

    // Fetch loans linked to applicant_id
    const { data: loans, error: loanError } = await supabaseClient
      .from("loan_applications")
      .select("*")
      .eq("applicant_id", applicant_id);

    if (loanError) {
      alert("Error loading loans: " + loanError.message);
      return;
    }

    const tbody = document.querySelector("#loan-status-table tbody");
    tbody.innerHTML = "";

    loans.forEach(loan => {
      const interest = 15;
      const totalOwed = (loan.loan_amount * 1.15).toFixed(2);

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>P${loan.loan_amount.toFixed(2)}</td>
        <td>${interest}%</td>
        <td>P${totalOwed}</td>
        <td>${loan.repayment_months} month(s)</td>
        <td class="${loan.status.toLowerCase()}">${loan.status}</td>
      `;
      tbody.appendChild(row);
    });
  }

  document.getElementById("logout-btn").addEventListener("click", async () => {
    const { error } = await supabaseClient.auth.signOut();
    if (!error) {
      window.location.href = "login.html";
    }
  });

  // Automatically load status if session is active
  loadUserLoanStatus();
</script>

</body>
</html>
